/**
 * =====================================================================
 * this(ë””ìŠ¤) - ë©´ì ‘ ë¹ˆì¶œ "ì´í•´ ì¤‘ì‹¬" ìµœì¢… í…œí”Œë¦¿ (2026)
 * =====================================================================
 * â­ = ì‹¤ë¬´ì—ì„œ ìì£¼ ì”€ / ğŸ”¥ = ë©´ì ‘ í•µì‹¬ / ğŸ›¡ï¸ = ì‹¤ìˆ˜ ë°©ì§€(Safety)
 *
 * [ë§¨ ìœ„ ê²°ë¡ : "ì§„ì§œ ì¤‘ìš”" vs "ê°œë…ë§Œ" âœ…]
 * âœ… ì§„ì§œ ì¤‘ìš”(ë©´ì ‘/ì‹¤ë¬´ ë‘˜ ë‹¤) â­ğŸ”¥
 * - thisëŠ” "ìŠ¤ì½”í”„"ê°€ ì•„ë‹ˆë‹¤. (ë³€ìˆ˜ ì°¾ê¸° ê·œì¹™ì´ ì•„ë‹˜)
 * - thisëŠ” "í˜¸ì¶œ ë°©ì‹(call-site)"ìœ¼ë¡œ ê²°ì •ëœë‹¤. ğŸ”¥
 * - 4ëŒ€ ê·œì¹™ë§Œ ì¡ìœ¼ë©´ ê±°ì˜ ë: ì¼ë°˜ í˜¸ì¶œ / ë©”ì„œë“œ í˜¸ì¶œ / new / bind(call/apply í¬í•¨)
 * - ì½œë°±ì—ì„œ thisê°€ ìì£¼ ê¹¨ì§„ë‹¤ â†’ arrow/bind/thisArgë¡œ ê³ ì¹œë‹¤ â­ğŸ›¡ï¸
 *
 * â˜‘ï¸ ê°œë…ë§Œ ì´í•´í•˜ë©´ ì¶©ë¶„
 * - strict ëª¨ë“œì™€ ë¹„-strict ì°¨ì´ëŠ” "ì™œ undefinedê°€ ëœ¨ëŠ”ì§€" ì´í•´ìš©
 * - class field arrow ë©”ì„œë“œëŠ” í¸í•˜ì§€ë§Œ ë‚¨ìš©í•˜ë©´ ë©”ëª¨ë¦¬ ë¹„ìš©ì´ ìˆë‹¤
 *
 * [í•µì‹¬ì •ë¦¬(ë¨¼ì € ì½ê¸°) ğŸ”¥]
 * 1) thisëŠ” "ì–´ë””ì„œ ì„ ì–¸"ì´ ì•„ë‹ˆë¼ "ì–´ë–»ê²Œ í˜¸ì¶œ"ëëŠ”ì§€ê°€ ì „ë¶€ë‹¤.
 * 2) strict ëª¨ë“œì—ì„œ ì¼ë°˜ í•¨ìˆ˜ í˜¸ì¶œ thisëŠ” undefinedê°€ ëœë‹¤. (ë²„ê·¸ ì¡°ê¸° ë°œê²¬) ğŸ›¡ï¸
 * 3) obj.method()ë©´ thisëŠ” obj(ì  ì™¼ìª½ receiver)ë‹¤.
 * 4) new Fn()ì´ë©´ thisëŠ” ìƒˆ ì¸ìŠ¤í„´ìŠ¤ë‹¤.
 * 5) bind/call/applyëŠ” thisë¥¼ ê°•ì œë¡œ ê³ ì •í•œë‹¤. â­
 * 6) arrowëŠ” thisë¥¼ "ìº¡ì²˜"í•´ì„œ ë°”ê¹¥ thisë¥¼ ê·¸ëŒ€ë¡œ ì“´ë‹¤. ğŸ”¥
 */

console.clear?.();

// ---------------------------------------------------------------------
// [Utility] ì¶œë ¥ í¬ë§·íŒ…
// ---------------------------------------------------------------------
const line = (n = 86) => '='.repeat(n);
const section = (title) => {
   console.log(`\n${line()}`);
   console.log(`â–¶ ${title}`);
   console.log(line());
};

const showThis = (label, value) => {
   // Nodeì—ì„œ ì „ì—­ thisëŠ” í™˜ê²½ì— ë”°ë¼ ë‹¤ë¥´ê²Œ ë³´ì¼ ìˆ˜ ìˆì–´ ë¬¸ìì—´ë¡œë§Œ ì •ë¦¬
   const printed = value === undefined ? 'undefined' : value;
   console.log(`${label}:`, printed);
};

// =====================================================================
// 1) [ì´ˆê¸‰] thisëŠ” "ìŠ¤ì½”í”„"ê°€ ì•„ë‹ˆë‹¤
// =====================================================================
{
   section('1. [ì´ˆê¸‰] thisëŠ” ìŠ¤ì½”í”„ê°€ ì•„ë‹ˆë‹¤');

   /**
    * ì™œ ì´ê±¸ ë¨¼ì € ê°•ì¡°í•˜ë‚˜?
    * - ìŠ¤ì½”í”„(lexical scope)ëŠ” "ì„ ì–¸ ìœ„ì¹˜"ë¡œ ê²°ì •
    * - thisëŠ” "í˜¸ì¶œ ë°©ì‹"ìœ¼ë¡œ ê²°ì •
    *
    * ë©´ì ‘ì—ì„œ ìì£¼ ë‚˜ì˜¤ëŠ” ë§:
    * - "JSëŠ” ë ‰ì‹œì»¬ ìŠ¤ì½”í”„"(ë§ìŒ)
    * - "ê·¸ë˜ì„œ thisë„ ë ‰ì‹œì»¬ì´ë‹¤"(ëŒ€ë¶€ë¶„ í‹€ë¦¼) âŒ
    */

   const outerValue = 'ë°– ë³€ìˆ˜';

   function readOuter() {
      // ìŠ¤ì½”í”„ ì˜ˆì‹œ: outerValueëŠ” ì„ ì–¸ ìœ„ì¹˜ ê¸°ì¤€ìœ¼ë¡œ ì½í˜
      return outerValue;
   }

   console.log('ìŠ¤ì½”í”„(ë³€ìˆ˜ ì°¾ê¸°):', readOuter());
}

// =====================================================================
// 2) [ì´ˆê¸‰] ì¼ë°˜ í•¨ìˆ˜ í˜¸ì¶œ: strict vs non-strict
// =====================================================================
{
   section('2. [ì´ˆê¸‰] ì¼ë°˜ í•¨ìˆ˜ í˜¸ì¶œ this (strict ëª¨ë“œ) ğŸ”¥');

   // ğŸ›¡ï¸ ì‹¤ë¬´ì—ì„œëŠ” strictë¥¼ ê¸°ë³¸ìœ¼ë¡œ ìƒê°í•˜ë©´ "ì¡°ìš©í•œ ë²„ê·¸"ë¥¼ ë¹¨ë¦¬ ì¡ëŠ”ë‹¤.
   (function () {
      'use strict';

      function plain() {
         return this;
      }

      showThis('strict plain()', plain()); // undefined
   })();

   // (ì°¸ê³ ) non-strictì—ì„œëŠ” í™˜ê²½ì— ë”°ë¼ ì „ì—­ ê°ì²´ë¡œ ë°”ì¸ë”©ë  ìˆ˜ ìˆìŒ
   // Node í™˜ê²½ì—ì„œëŠ” ëª¨ë“ˆ ìŠ¤ì½”í”„ ë“±ìœ¼ë¡œ ì¸í•´ ê¸°ëŒ€ì™€ ë‹¤ë¥¼ ìˆ˜ ìˆì–´ "ê°’ ë¹„êµ"ëŠ” ì§€ì–‘
   (function () {
      function plain() {
         return this;
      }

      showThis('non-strict plain()', plain());
   })();
}

// =====================================================================
// 3) [ì´ˆê¸‰] ë©”ì„œë“œ í˜¸ì¶œ: ì (.) ì™¼ìª½ì´ this
// =====================================================================
{
   section('3. [ì´ˆê¸‰] obj.method()ì—ì„œ thisëŠ” obj â­');

   const user = {
      name: 'ì‹ ì¬ì¤€',
      sayHello() {
         // ì™œ this.name?
         // - ê°™ì€ í•¨ìˆ˜ë¼ë„ ì–´ë–¤ ê°ì²´ê°€ í˜¸ì¶œí•˜ëŠëƒì— ë”°ë¼ ë‹¤ë¥¸ nameì„ ë³´ê²Œ ë§Œë“¤ê¸° ìœ„í•´
         return `ì•ˆë…•í•˜ì„¸ìš”, ${this.name}ì…ë‹ˆë‹¤.`;
      },
   };

   console.log(user.sayHello());

   // ğŸ›¡ï¸ í•¨ìˆ˜ë¥¼ ë¶„ë¦¬(detach)í•˜ë©´ "í˜¸ì¶œë¶€"ê°€ ë°”ë€Œì–´ì„œ thisê°€ ê¹¨ì§ˆ ìˆ˜ ìˆë‹¤.
   const detached = user.sayHello;

   (function () {
      'use strict';
      try {
         console.log(detached());
      } catch (e) {
         console.log('detached() ì‹¤íŒ¨(ì •ìƒ):', e.message);
      }
   })();
}

// =====================================================================
// 4) [ì´ˆê¸‰] new í˜¸ì¶œ: thisëŠ” ìƒˆ ì¸ìŠ¤í„´ìŠ¤
// =====================================================================
{
   section('4. [ì´ˆê¸‰] new Fn()ì—ì„œ thisëŠ” ì¸ìŠ¤í„´ìŠ¤ â­');

   function Person(name, year) {
      this.name = name;
      this.year = year;
   }

   Person.prototype.introduce = function () {
      return `[Person] ${this.year}ë…„ìƒ ${this.name}`;
   };

   const p = new Person('ì‹ ì¬ì¤€', 1996);
   console.log(p.introduce());
}

// =====================================================================
// 5) [ì¤‘ê¸‰] call/apply/bind: thisë¥¼ ê°•ì œë¡œ ê³ ì • â­ğŸ”¥
// =====================================================================
{
   section('5. [ì¤‘ê¸‰] call/apply/bind (â­ this ê°•ì œ ê³ ì •)');

   function returnName() {
      return this?.name;
   }

   const a = { name: 'ì•ˆìœ ì§„' };
   const b = { name: 'ì¥ì›ì˜' };

   console.log('call:', returnName.call(a));
   console.log('apply:', returnName.apply(b));

   function multiply(x, y, z) {
      return `${this.name} / ê²°ê³¼ ${x * y * z}`;
   }

   // call: ì¸ìë¥¼ ì½¤ë§ˆë¡œ
   console.log('call args:', multiply.call(a, 2, 3, 4));

   // apply: ì¸ìë¥¼ ë°°ì—´ë¡œ
   console.log('apply args:', multiply.apply(b, [2, 3, 4]));

   // bind: "ë°”ë¡œ ì‹¤í–‰"ì´ ì•„ë‹ˆë¼, thisê°€ ê³ ì •ëœ "ìƒˆ í•¨ìˆ˜"ë¥¼ ë°˜í™˜
   const later = multiply.bind(a, 2, 3, 4);
   console.log('bind later():', later());
}

// =====================================================================
// 6) [ê³ ê¸‰] ğŸ”¥ Arrow Function: thisë¥¼ "ìº¡ì²˜"í•œë‹¤(ë ‰ì‹œì»¬ this)
// =====================================================================
{
   section('6. [ê³ ê¸‰] Arrowì˜ this: ë°”ê¹¥ thisë¥¼ ìº¡ì²˜ ğŸ”¥');

   /**
    * ì™œ arrowê°€ ì¤‘ìš”?
    * - ì½œë°±ì—ì„œ thisê°€ ê¹¨ì§€ëŠ” ë¬¸ì œë¥¼ "ìì—°ìŠ¤ëŸ½ê²Œ" í•´ê²°í•˜ëŠ” ê²½ìš°ê°€ ë§ë‹¤.
    *
    * ì£¼ì˜:
    * - arrowëŠ” call/apply/bindë¡œ thisë¥¼ ë°”ê¿€ ìˆ˜ ì—†ë‹¤(ì´ë¯¸ ìº¡ì²˜ë¨). ğŸ”¥
    */

   const team = {
      name: 'IVE',

      // ì¼ë°˜ ë©”ì„œë“œ: í˜¸ì¶œë¶€(team.) ê¸°ì¤€ìœ¼ë¡œ this ê²°ì •
      showThisNormal() {
         return this.name;
      },

      // arrow: team ê°ì²´ì˜ thisë¥¼ ìë™ìœ¼ë¡œ ê°€ì§€ëŠ” ê²Œ ì•„ë‹ˆë¼,
      // "ì„ ì–¸ëœ ìœ„ì¹˜"ì˜ thisë¥¼ ìº¡ì²˜í•œë‹¤.
      // ê·¸ë˜ì„œ ê°ì²´ ë¦¬í„°ëŸ´ ë‚´ë¶€ì—ì„œ arrow ë©”ì„œë“œëŠ” ìì£¼ í•¨ì •ì´ ëœë‹¤. ğŸ›¡ï¸
      showThisArrow: () => {
         return this?.name;
      },
   };

   console.log('normal method:', team.showThisNormal()); // IVE
   console.log('arrow method:', team.showThisArrow()); // ëŒ€ë¶€ë¶„ undefined
}

// =====================================================================
// 7) [ì‹¤ë¬´íŒ¨í„´] â­ ì½œë°± this í•¨ì • + í•´ê²°ë²• 3ì¢… ì„¸íŠ¸
// =====================================================================
{
   section('7. [ì‹¤ë¬´íŒ¨í„´] ì½œë°± this ê¹¨ì§ + í•´ê²°ë²•(arrow/bind/thisArg) â­');

   const controller = {
      count: 0,

      inc() {
         this.count += 1;
      },

      runBad() {
         // âŒ ì½œë°±ìœ¼ë¡œ ë„˜ê¸°ëŠ” ìˆœê°„, incê°€ "ì–´ë–»ê²Œ í˜¸ì¶œë˜ëŠëƒ"ê°€ ë°”ë€œ
         // setTimeout(ì½œë°±)ì—ì„œ ì½œë°±ì€ ì¼ë°˜ í•¨ìˆ˜ í˜¸ì¶œì²˜ëŸ¼ ì‹¤í–‰ë  ìˆ˜ ìˆì–´ thisê°€ ê¹¨ì§„ë‹¤.
         setTimeout(this.inc, 0);
      },

      runWithBind() {
         // âœ… bindë¡œ thisë¥¼ ê³ ì •
         setTimeout(this.inc.bind(this), 0);
      },

      runWithArrow() {
         // âœ… arrowë¡œ ë°”ê¹¥ thisë¥¼ ìº¡ì²˜
         setTimeout(() => this.inc(), 0);
      },

      runWithThisArg() {
         // âœ… ë°°ì—´ ë©”ì„œë“œ(forEach/map/filter)ì˜ thisArg í™œìš©
         [1, 2, 3].forEach(function () {
            this.inc();
         }, this);
      },
   };

   // strict ëª¨ë“œì—ì„œ ì°¨ì´ë¥¼ í™•ì‹¤íˆ ë³´ê¸° ìœ„í•´ IIFE
   (function () {
      'use strict';

      controller.runBad();
      setTimeout(() => {
         console.log('runBad ì´í›„ count(ëŒ€ê°œ 0):', controller.count);

         controller.runWithBind();
         controller.runWithArrow();
         controller.runWithThisArg();

         setTimeout(() => {
            console.log('í•´ê²° í›„ count(3 ê¸°ëŒ€):', controller.count);
         }, 0);
      }, 0);
   })();
}

// =====================================================================
// 8) [ì‹¤ë¬´íŒ¨í„´] class ë©”ì„œë“œ vs class field arrow ë©”ì„œë“œ (ê°„ë‹¨ ë¹„êµ)
// =====================================================================
{
   section('8. [ì‹¤ë¬´íŒ¨í„´] class method vs arrow field (âš–ï¸ ì„ íƒ ê¸°ì¤€)');

   /**
    * class method(ì •ì„): prototype ê³µìœ  â†’ ë©”ëª¨ë¦¬ íš¨ìœ¨ ì¢‹ìŒ â­
    * arrow field: ì¸ìŠ¤í„´ìŠ¤ë§ˆë‹¤ í•¨ìˆ˜ ìƒì„± â†’ ë°”ì¸ë”© ë¬¸ì œëŠ” ì¤„ì§€ë§Œ ë¹„ìš©â†‘ ğŸ›¡ï¸
    */

   class Counter {
      value = 0;

      // ì •ì„(ê³µìœ )
      inc() {
         this.value += 1;
      }

      // í¸ì˜(ì¸ìŠ¤í„´ìŠ¤ë§ˆë‹¤ ìƒì„±)
      incArrow = () => {
         this.value += 1;
      };
   }

   const c1 = new Counter();
   const c2 = new Counter();

   console.log('method ê³µìœ ?', c1.inc === c2.inc); // true
   console.log('arrow ê³µìœ ?', c1.incArrow === c2.incArrow); // false
}

// =====================================================================
// 9) [í•µì‹¬ì •ë¦¬] ë³µìŠµ ì²´í¬ë¦¬ìŠ¤íŠ¸ 12ê°œ âœ…
// =====================================================================
{
   section('9. [í•µì‹¬ì •ë¦¬] ë³µìŠµ ì²´í¬ë¦¬ìŠ¤íŠ¸ 12ê°œ âœ…');

   const checklist = [
      'thisëŠ” ìŠ¤ì½”í”„ê°€ ì•„ë‹ˆë¼ í˜¸ì¶œ ë°©ì‹(call-site)ìœ¼ë¡œ ê²°ì •ëœë‹¤. ğŸ”¥',
      'strict ëª¨ë“œì—ì„œ ì¼ë°˜ í•¨ìˆ˜ í˜¸ì¶œ thisëŠ” undefinedë‹¤(ë²„ê·¸ ì¡°ê¸° ë°œê²¬). ğŸ›¡ï¸',
      'obj.method()ì—ì„œ thisëŠ” ì (.) ì™¼ìª½ ê°ì²´(receiver)ë‹¤. â­',
      'í•¨ìˆ˜ë¥¼ ë¶„ë¦¬(detach)í•˜ë©´ í˜¸ì¶œë¶€ê°€ ë°”ë€Œì–´ thisê°€ ê¹¨ì§ˆ ìˆ˜ ìˆë‹¤. ğŸ›¡ï¸',
      'new Fn()ì—ì„œ thisëŠ” ìƒˆë¡œ ìƒì„±ëœ ì¸ìŠ¤í„´ìŠ¤ë‹¤. â­',
      'callì€ thisë¥¼ ì§€ì •í•˜ê³  ì¸ìë¥¼ ì½¤ë§ˆë¡œ ì „ë‹¬í•œë‹¤. â­',
      'applyëŠ” thisë¥¼ ì§€ì •í•˜ê³  ì¸ìë¥¼ ë°°ì—´ë¡œ ì „ë‹¬í•œë‹¤. â­',
      'bindëŠ” thisê°€ ê³ ì •ëœ "ìƒˆ í•¨ìˆ˜"ë¥¼ ë°˜í™˜í•˜ë©° ë‚˜ì¤‘ì— ì‹¤í–‰í•œë‹¤. â­',
      'arrowëŠ” thisë¥¼ ë°”ê¹¥ì—ì„œ ìº¡ì²˜í•˜ë¯€ë¡œ call/apply/bindë¡œ ë°”ê¿€ ìˆ˜ ì—†ë‹¤. ğŸ”¥',
      'ê°ì²´ ë¦¬í„°ëŸ´ì—ì„œ arrow ë©”ì„œë“œëŠ” this í•¨ì •ì´ ë  ìˆ˜ ìˆë‹¤(ëŒ€ê°œ undefined). ğŸ›¡ï¸',
      'ì½œë°±ì—ì„œ thisê°€ ê¹¨ì§€ë©´ arrow/bind/thisArgë¡œ í•´ê²°í•œë‹¤. â­ğŸ›¡ï¸',
      'class field arrow ë©”ì„œë“œëŠ” ë°”ì¸ë”©ì€ í¸í•˜ì§€ë§Œ ì¸ìŠ¤í„´ìŠ¤ë§ˆë‹¤ ìƒì„±(ë¹„ìš©â†‘). ğŸ›¡ï¸',
   ];

   checklist.forEach((item, idx) => {
      console.log(`${String(idx + 1).padStart(2, '0')}. ${item}`);
   });
}

console.log(`\n${line()}`);
console.log('this ìµœì¢… í…œí”Œë¦¿ ë! âœ…');
console.log(line());
